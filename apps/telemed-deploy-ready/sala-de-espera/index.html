<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sala de Espera – TeleMed</title>
  <style>
    :root {
      --bg:#0b1220; --card:#111a2b; --muted:#a5b4c3; --fg:#e6edf3;
      --ok:#17c964; --warn:#f5a524; --err:#f31260; --btn:#0072f5;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid #21304b;border-radius:16px;padding:24px;box-shadow:0 6px 24px #0006}
    h1{margin:0 0 8px;font-size:28px}
    .muted{color:var(--muted)}
    .row{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px}
    .btn{appearance:none;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--btn);color:#fff}
    .btn-ghost{background:transparent;border:1px solid #2a3a59;color:#d9e3f0}
    .chip{display:inline-block;border:1px solid #26344f;border-radius:999px;padding:6px 10px;font-size:13px;background:#0c1a30;margin-left:6px}
    .sep{border-top:1px dashed #22314d;margin:18px 0}
    .status{display:inline-block;border-radius:999px;padding:6px 10px;font-size:12px}
    .s-wait{background:#2a2410;border:1px solid #53461a;color:#ffd27b}
    .s-ok{background:#0e2720;border:1px solid #1a3e33;color:#79f2a6}
    .s-err{background:#2a0e15;border:1px solid #51202a;color:#ffb3c0}
    .note{font-size:12px;color:#a5b4c3}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Sala de Espera <span id="chip" class="chip">–</span></h1>
      <p class="muted">Aguarde aqui até o(a) médico(a) iniciar a chamada. Quando for chamado, você será direcionado para a sala de vídeo.</p>

      <div class="row">
        <button id="join" class="btn btn-primary">Entrar na Consulta (quando chamado)</button>
        <button id="copy" class="btn btn-ghost">Copiar link desta sala</button>
      </div>
      <div id="copied" class="note" style="display:none;margin-top:6px">Link copiado ✔</div>

      <div class="sep"></div>

      <div>
        <div class="muted">Status</div>
        <div id="status" class="status s-wait">Aguardando médico…</div>
        <div id="redir" class="note" style="display:none;margin-top:6px"></div>
      </div>

      <div class="sep"></div>

      <div class="muted">Dicas</div>
      <ul class="muted" style="margin-top:6px">
        <li>Deixe câmera e microfone autorizados no navegador.</li>
        <li>Se o médico atrasar, este status permanece em “Aguardando médico…”.</li>
      </ul>

      <div class="row" style="margin-top:12px">
        <a class="btn btn-ghost" href="/index.html">Voltar ao Hub</a>
        <a class="btn btn-ghost" href="/example-integration.html#scribe" target="_blank">Abrir Scribe/CIDs</a>
      </div>
    </div>
  </div>

  <script>
    // --- 1) ticket = appointmentId || room || ticket (fallback)
    const qs = new URLSearchParams(location.search);
    const ticket = (qs.get('appointmentId') || qs.get('room') || qs.get('ticket') || 'telemed-demo').trim();
    document.getElementById('chip').textContent = ticket ? ('#' + ticket) : '—';

    // --- 2) URLs de consulta (perfil do paciente)
    const consultaUrl = `/consulta/?appointmentId=${encodeURIComponent(ticket)}&role=patient`;

    // Botões
    document.getElementById('join').onclick = () => { location.href = consultaUrl; };
    document.getElementById('copy').onclick = async () => {
      try {
        await navigator.clipboard.writeText(location.href);
        const el = document.getElementById('copied');
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 1800);
      } catch(e) { alert('Não foi possível copiar o link.'); }
    };

    // --- 3) Polling do status (seu backend pode responder {status:"ready"} ou similar)
    const $status = document.getElementById('status');
    const $redir  = document.getElementById('redir');

    async function fetchStatus() {
      try {
        const r = await fetch(`/api/consultas/status?ticket=${encodeURIComponent(ticket)}&t=${Date.now()}`, { cache:'no-store' });
        const data = await r.json().catch(()=> ({}));
        return (data && (data.status || data.state)) || 'waiting';
      } catch { return 'waiting'; }
    }

    function setBadge(kind, text){
      $status.className = 'status ' + (kind==='ok' ? 's-ok' : kind==='err' ? 's-err' : 's-wait');
      $status.textContent = text;
    }

    async function poll(){
      const st = await fetchStatus();
      if (st === 'ready' || st === 'called' || st === 'ok') {
        setBadge('ok', 'Chamado! A consulta vai abrir…');
        $redir.style.display = 'block';
        $redir.textContent = 'Redirecionando em 5 segundos. Se preferir, clique no botão "Entrar na Consulta".';
        setTimeout(() => { location.href = consultaUrl; }, 5000);
        return; // para de pollar
      }
      // continua aguardando
      setBadge('wait', 'Aguardando médico…');
      setTimeout(poll, 4000);
    }
    poll();
  </script>
</body>
</html>
