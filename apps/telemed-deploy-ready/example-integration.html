<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TeleMed — Hub de Integração</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --text:#e2e8f0;
      --primary:#0ea5e9; --border:#1e293b; --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    .grid{display:grid;gap:16px}
    @media(min-width:980px){ .grid-3{grid-template-columns:1fr 1fr 1fr} .grid-2{grid-template-columns:1fr 1fr} }
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:18px}
    h1{margin:0 0 10px;font-size:26px}
    h2{margin:0 0 12px;font-size:18px}
    .muted{color:var(--muted)}
    label{display:block;font-size:13px;color:#cbd5e1;margin:8px 2px 6px}
    input{width:100%;background:#0b1220;border:1px solid var(--border);border-radius:12px;color:var(--text);padding:10px 12px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);cursor:pointer;color:#fff;background:var(--primary);font-weight:600}
    .btn.ghost{background:transparent;color:#93c5fd}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;border:1px solid var(--border);background:#0b1530}
    .ok{color:#4ade80} .bad{color:#f87171}
    .routes a{display:block;margin:8px 0 0;color:#93c5fd;text-decoration:none}
    .routes a:hover{text-decoration:underline}
    pre{white-space:pre-wrap;background:#0b1220;border:1px solid var(--border);border-radius:12px;padding:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>TeleMed — Hub de Integração</h1>
    <p class="muted">Defina as URLs dos serviços, salve, e use os testes abaixo. As URLs ficam no <code>localStorage</code>.</p>

    <!-- Config -->
    <div class="card">
      <h2>Configurar URLs</h2>
      <div class="grid grid-3">
        <div>
          <label>AUCTION_URL</label>
          <input id="AUCTION_URL" placeholder="https://telemed-auction.onrender.com">
        </div>
        <div>
          <label>INTERNAL_URL</label>
          <input id="INTERNAL_URL" placeholder="https://telemed-internal.onrender.com">
        </div>
        <div>
          <label>PRODUCTIVITY_URL</label>
          <input id="PRODUCTIVITY_URL" placeholder="https://telemed-productivity.onrender.com">
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="save" class="btn">Salvar</button>
        <button id="clear" class="btn ghost">Limpar (localStorage)</button>
        <span class="muted">Dica: depois de salvar, faça um hard refresh (Ctrl/Cmd+Shift+R) se algo não aparecer.</span>
      </div>
    </div>

    <!-- Status -->
    <div class="grid grid-3" style="margin-top:16px">
      <div class="card">
        <h2>AUCTION</h2>
        <div class="row" style="justify-content:space-between">
          <span class="pill">URL: <span id="badge-auction" class="muted"></span></span>
          <button class="btn" id="test-auction">Testar /healthz</button>
        </div>
        <div id="out-auction" style="margin-top:10px" class="muted"></div>
      </div>

      <div class="card">
        <h2>INTERNAL</h2>
        <div class="row" style="justify-content:space-between">
          <span class="pill">URL: <span id="badge-internal" class="muted"></span></span>
          <button class="btn" id="test-internal">Testar /healthz</button>
        </div>
        <div id="out-internal" style="margin-top:10px" class="muted"></div>
      </div>

      <div class="card">
        <h2>PRODUCTIVITY</h2>
        <div class="row" style="justify-content:space-between">
          <span class="pill">URL: <span id="badge-prod" class="muted"></span></span>
          <button class="btn" id="test-prod">Testar /healthz</button>
        </div>
        <div id="out-prod" style="margin-top:10px" class="muted"></div>
      </div>
    </div>

    <!-- Rotas úteis -->
    <div class="grid grid-2" style="margin-top:16px">
      <div class="card routes">
        <h2>Páginas de Demo</h2>
        <a href="/cadastro.html">Cadastro de Paciente</a>
        <a href="/cadastro-medico.html">Cadastro de Médico</a>
        <a href="/demo.html">Demo Médico (BIDs / Accept)</a>
        <a href="/video.html">Sala de Vídeo (Jitsi)</a>
        <a href="/sala-de-espera.html">Sala de Espera (Paciente)</a>
        <!-- ===== Dr. AI – Configuração & Teste ===== -->
        <section class="card" style="margin-top:16px">
          <h3 style="margin:0 0 8px">Dr. AI (LLM)</h3>
          <p class="muted" style="margin:4px 0 12px">
            Use o token interno e teste uma chamada protegida no <code>telemed-internal</code>.
          </p>

          <div class="row" style="align-items:flex-end;gap:12px;flex-wrap:wrap">
            <div>
              <label class="muted" for="drai-url">INTERNAL_URL</label><br/>
              <input id="drai-url" name="INTERNAL_URL" style="min-width:360px;padding:8px;border-radius:8px;border:1px solid #2a3a59"/>
            </div>
            <div>
              <label class="muted" for="drai-token">INTERNAL_TOKEN</label><br/>
              <input id="drai-token" type="password" placeholder="••••••••" style="min-width:300px;padding:8px;border-radius:8px;border:1px solid #2a3a59"/>
            </div>
            <div style="display:flex;gap:8px">
              <button id="drai-save" class="btn btn-ghost">Salvar</button>
              <button id="drai-test" class="btn btn-primary">Testar Dr. AI</button>
            </div>
          </div>

          <div id="drai-out" class="muted" style="margin-top:10px"></div>
        </section>

        <script>
        (function(){
          const $ = (s)=>document.querySelector(s);
          const urlInp   = $('#drai-url');
          const tokenInp = $('#drai-token');
          const out      = $('#drai-out');

          // preencher com o que já existe no localStorage
          urlInp.value   = localStorage.getItem('INTERNAL_URL')   || 'https://telemed-internal.onrender.com';
          tokenInp.value = localStorage.getItem('INTERNAL_TOKEN') || '';

          $('#drai-save').onclick = () => {
            localStorage.setItem('INTERNAL_URL', urlInp.value.trim());
            localStorage.setItem('INTERNAL_TOKEN', tokenInp.value.trim());
            out.style.color = '#a5b4c3';
            out.textContent = 'Salvo no navegador.';
          };

          // teste robusto (aceita /healthz em texto e tenta vários endpoints de AI)
          async function testDrAI(){
            const base = (urlInp.value || '').replace(/\/$/,'').trim();
            const tok  = (tokenInp.value || '').trim();
            if (!base) { out.style.color='#ef4444'; out.textContent='Configure INTERNAL_URL.'; return; }
            out.style.color='#a5b4c3'; out.textContent='Testando…';

            // 1) health
            try {
              const r = await fetch(base + '/healthz', {mode:'cors'});
              const t = await r.text().catch(()=> '');
              if (!r.ok) throw new Error('healthz ' + r.status);
            } catch(e) {
              out.style.color='#ef4444'; out.textContent='Falha no /healthz: ' + (e.message||e);
              return;
            }

            // 2) endpoints candidatos de AI (o backend pode expor nomes diferentes)
            const candidates = [
              ['/ai/ping',          {text:'ping'}],
              ['/ai/echo',          {text:'ping'}],
              ['/ai/complete',      {messages:[{role:'user',content:'Diga "ok" se estiver funcionando.'}], stream:false}],
              ['/enhanced/chat',    {messages:[{role:'user',content:'Diga "ok".'}], stream:false}],
              ['/chat',             {messages:[{role:'user',content:'ok?'}]}],
              ['/chat/completions', {model:'gpt-4o-mini', messages:[{role:'user',content:'ok?'}], stream:false}],
            ];

            for (const [path, body] of candidates) {
              try {
                const r = await fetch(base + path, {
                  method:'POST',
                  mode:'cors',
                  headers:{
                    'Content-Type':'application/json',
                    'X-Internal-Token': tok
                  },
                  body: JSON.stringify(body)
                });
                const text = await r.text(); // pode ser JSON ou texto
                if (r.ok) {
                  out.style.color='#16a34a';
                  out.textContent = `OK em ${path} — resposta: ` + (text.slice(0,160) || '(vazia)');
                  return;
                }
              } catch(e) { /* tenta o próximo */ }
            }
            out.style.color='#ef4444';
            out.textContent = 'Falhou nas rotas de AI (token inválido, rota diferente ou CORS).';
          }

          $('#drai-test').onclick = testDrAI;
        })();
        </script>

        
        <div class="muted" style="margin-top:8px;font-size:12px">
          Sala de Espera com ID: <code>/sala-de-espera.html?appointmentId=&lt;ID&gt;</code>
        </div>
      </div>
      <div class="card">
        <h2>Exemplo de uso (curl)</h2>
        <p class="muted">Copie, troque os IDs e rode no terminal:</p>
        <pre id="curlbox"></pre>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const $ = s => document.querySelector(s);

    // Carregar/salvar config em localStorage
    const keys = ['AUCTION_URL','INTERNAL_URL','PRODUCTIVITY_URL'];
    function load(){
      keys.forEach(k=>{
        const v = localStorage.getItem(k) || '';
        $('#'+k).value = v;
      });
      updateBadges();
      renderCurl();
    }
    function save(){
      keys.forEach(k=>{
        const v = $('#'+k).value.trim().replace(/\/$/,'');
        if (v) localStorage.setItem(k, v); else localStorage.removeItem(k);
      });
      updateBadges();
      renderCurl();
    }
    function clearAll(){
      keys.forEach(k=>localStorage.removeItem(k));
      load();
    }
    function get(k){ return (localStorage.getItem(k) || '').replace(/\/$/,''); }

    // UI
    function updateBadges(){
      $('#badge-auction').textContent  = get('AUCTION_URL')      || '(não definido)';
      $('#badge-internal').textContent = get('INTERNAL_URL')     || '(não definido)';
      $('#badge-prod').textContent     = get('PRODUCTIVITY_URL') || '(não definido)';
    }

    async function ping(url, outEl){
      if (!url){ outEl.innerHTML = '<span class="bad">URL não configurada.</span>'; return; }
      outEl.textContent = 'Testando...';
      try{
        const r = await fetch(url.replace(/\/$/,'') + '/healthz');
        const txt = await r.text();
        outEl.innerHTML = r.ok
          ? `<span class="ok">OK</span> ${txt}`
          : `<span class="bad">Falhou</span> ${r.status} ${txt}`;
      }catch(e){
        outEl.innerHTML = `<span class="bad">Erro:</span> ${e.message}`;
      }
    }

    function renderCurl(){
      const a = get('AUCTION_URL') || 'https://telemed-auction.onrender.com';
      $('#curlbox').textContent =
`# Criar BID (troque patientId e specialty)
curl -X POST ${a}/bids \\
  -H "Content-Type: application/json" \\
  -d '{"patientId":"12345678901","amountCents":9000,"mode":"immediate","specialty":"Cardiologia"}'

# Aceitar BID
curl -X POST ${a}/bids/<BID_ID>/accept \\
  -H "Content-Type: application/json" \\
  -d '{"patientId":"12345678901"}'`;
    }

    // eventos
    $('#save').onclick = save;
    $('#clear').onclick = clearAll;
    $('#test-auction').onclick  = ()=> ping(get('AUCTION_URL'),  $('#out-auction'));
    $('#test-internal').onclick = ()=> ping(get('INTERNAL_URL'), $('#out-internal'));
    $('#test-prod').onclick     = ()=> ping(get('PRODUCTIVITY_URL'), $('#out-prod'));

    load();
  })();
  </script>
</body>
</html>