<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TeleMed - Cadastro de Paciente</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#9fb0d7; --text:#e7eefc;
      --primary:#0ea5e9; --primary-600:#0284c7; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
      --input:#0f172a; --border:#1f2a44;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
      background: linear-gradient(180deg, #0a1020, #0b1220 30%, #0b1220);
      color:var(--text);
    }
    .wrap{max-width:920px;margin:48px auto;padding:0 16px}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    .logo{
      width:36px;height:36px;border-radius:10px;
      background: radial-gradient(circle at 30% 30%, #4ade80 0 35%, #22c55e 36% 60%, #16a34a 61% 100%);
      box-shadow: 0 0 0 1px #1f2937, 0 6px 20px rgba(16,185,129,.25);
    }
    h1{margin:0;font-size:28px;letter-spacing:.3px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--card);
      border:1px solid var(--border);
      border-radius:16px;padding:22px 20px;box-shadow:0 8px 30px rgba(0,0,0,.35);
    }
    .muted{color:var(--muted);font-size:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px}
    .row-1{display:grid;grid-template-columns:1fr;gap:14px;margin-top:16px}
    @media (max-width:800px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:13px;color:var(--muted);margin:6px 2px}
    input,textarea,select{
      width:100%;border-radius:12px;border:1px solid var(--border);
      background: var(--input); color:var(--text); padding:12px 14px; outline:none;
      transition:border-color .2s, box-shadow .2s;
    }
    input:focus,textarea:focus,select:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(14,165,233,.18)}
    textarea{min-height:96px;resize:vertical}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:18px}
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid transparent;cursor:pointer;
      background:var(--primary);color:#fff;font-weight:600
    }
    .btn:hover{background:var(--primary-600)}
    .btn.ghost{background:transparent;border-color:var(--border);color:var(--text)}
    .btn.ghost:hover{border-color:var(--primary)}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:10px 14px;
      border:1px solid var(--border);background:#0d1526;margin:8px 6px 0 0}
    .pill small{color:var(--muted)}
    .alert{margin-top:14px;padding:12px 14px;border-radius:12px;border:1px solid var(--border)}
    .alert.ok{border-color:#115e59;background:rgba(16,185,129,.08)}
    .alert.err{border-color:#7f1d1d;background:rgba(239,68,68,.08)}
    .grid-top{display:grid;grid-template-columns:2fr 1fr;gap:12px}
    @media (max-width:800px){.grid-top{grid-template-columns:1fr}}
    .nav{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    code{background:#0f172a;border:1px solid var(--border);padding:2px 6px;border-radius:8px}
  </style>
  <script>
    // Carrega possível configuração global
    let INTERNAL_URL =
      (window.telemedConfig && window.telemedConfig.INTERNAL_URL) ||
      localStorage.getItem('INTERNAL_URL') ||
      'https://telemed-internal.onrender.com';

    function onlyDigits(s){ return (s||'').replace(/\D+/g,''); }

    function loadFromLocal(cpf){
      try{
        const raw = localStorage.getItem('cadastro-'+cpf);
        return raw ? JSON.parse(raw) : null;
      }catch{ return null; }
    }
    function saveToLocal(cpf, data){
      localStorage.setItem('cadastro-'+cpf, JSON.stringify(data));
      localStorage.setItem('lastCPF', cpf);
    }

    async function trySendToBackend(payload){
      try{
        const res = await fetch(INTERNAL_URL.replace(/\/+$/,'')+'/patients',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const t = await res.text();
          return { ok:false, message:`Backend respondeu ${res.status}: ${t.slice(0,200)}` };
        }
        const j = await res.json().catch(()=>({}));
        return { ok:true, data:j };
      }catch(e){
        return { ok:false, message:e.message };
      }
    }

    function el(id){ return document.getElementById(id); }

    function fillForm(d){
      if(!d) return;
      el('cpf').value = d.cpf || '';
      el('name').value = d.name || '';
      el('birth').value = d.birth || '';
      el('phone').value = d.phone || '';
      el('email').value = d.email || '';
      el('notes').value = d.notes || '';
    }

    function setAlert(type,msg){
      const box = el('alert'); box.className='alert '+type; box.innerText=msg; box.hidden=false;
    }

    function clearAlert(){ el('alert').hidden=true; }

    function toPayload(){
      const cpf = onlyDigits(el('cpf').value);
      const name = el('name').value.trim();
      const birth = el('birth').value;
      const phone = el('phone').value.trim();
      const email = el('email').value.trim();
      const notes = el('notes').value.trim();
      return { patientId: cpf, cpf, name, birth, phone, email, notes };
    }

    function validate(p){
      if(!p.patientId || p.patientId.length!==11) return 'CPF deve conter 11 dígitos.';
      if(!p.name || p.name.length<3) return 'Informe o nome completo.';
      if(!p.birth) return 'Informe a data de nascimento.';
      return null;
    }

    async function onSave(ev){
      ev.preventDefault(); clearAlert();
      const payload = toPayload();
      const err = validate(payload);
      if(err){ setAlert('err', err); return; }

      // Persistência local p/ demo
      saveToLocal(payload.patientId, payload);

      // Tentativa de enviar ao backend (opcional)
      const sent = await trySendToBackend(payload);
      if(sent.ok){
        setAlert('ok', 'Cadastro salvo localmente e enviado ao backend.');
      }else{
        setAlert('warn', 'Cadastro salvo localmente. (Backend opcional) Detalhe: '+sent.message);
      }
    }

    function goDemo(){
      const cpf = onlyDigits(el('cpf').value);
      if(!cpf || cpf.length!==11){ setAlert('err','Informe um CPF válido (11 dígitos).'); return; }
      location.href = '/demo.html?patientId='+encodeURIComponent(cpf);
    }

    function clearAll(){
      el('form').reset(); clearAlert();
    }

    function onCpfInput(){
      const cpf = onlyDigits(el('cpf').value);
      if(cpf.length===11){
        const data = loadFromLocal(cpf);
        fillForm(data||{});
      }
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      const last = localStorage.getItem('lastCPF');
      if(last){ el('cpf').value = last; const d=loadFromLocal(last); fillForm(d); }
      el('cpf').addEventListener('input', onCpfInput);
      el('form').addEventListener('submit', onSave);
      el('btn-demo').addEventListener('click', goDemo);
      el('btn-clear').addEventListener('click', clearAll);
    });
  </script>
</head>
<body>
  <div class="wrap">
    <div class="brand"><div class="logo"></div><h1>TeleMed – Cadastro</h1></div>
    <div class="card">
      <div class="grid-top">
        <p class="muted">Preencha os dados do paciente. Para demo, os dados ficam no seu navegador (localStorage) e tentamos enviar também ao <code>INTERNAL_URL</code> se estiver disponível.</p>
        <div class="pill"><small>INTERNAL_URL</small><span id="url-internal"></span></div>
      </div>

      <form id="form" class="row">
        <div>
          <label for="cpf">CPF (11 dígitos)</label>
          <input
            id="cpf"
            name="cpf"
            type="text"
            inputmode="numeric"
            autocomplete="off"
            maxlength="11"
            placeholder="Somente números"
          />
          <small id="cpf-hint" class="hint" style="color:#f87171;display:none"></small>
        </div>
        <div>
          <label for="name">Nome completo</label>
          <input id="name" placeholder="Ex.: Maria da Silva" />
        </div>

        <div>
          <label for="birth">Data de nascimento</label>
          <input id="birth" type="date" />
        </div>
        <div>
          <label for="phone">Telefone</label>
          <input id="phone" placeholder="(11) 9 9999-9999" />
        </div>

        <div>
          <label for="email">E-mail</label>
          <input id="email" type="email" placeholder="exemplo@dominio.com" />
        </div>
        <div>
          <label for="notes">Observações</label>
          <textarea id="notes" placeholder="Alergias, comorbidades, etc. (opcional)"></textarea>
        </div>
      </form>

      <div id="alert" class="alert" hidden></div>

      <div class="actions">
        <button class="btn" form="form" type="submit">Salvar cadastro</button>
        <button class="btn ghost" id="btn-clear" type="button">Limpar</button>
        <button class="btn" id="btn-demo" type="button">Ir para Demo Médico</button>
        <a class="btn ghost" href="/index.html">Voltar ao Hub</a>
        <a class="btn ghost" href="/example-integration.html">Exemplo de Integração</a>
      </div>
    </div>

    <script>
      // mostra a URL resolvida no topo
      document.getElementById('url-internal').textContent = (INTERNAL_URL||'').replace(/\/+$/,'');
    </script>
  </div>
  <script src="/js/config.js"></script>

<script>
(() => {
  const cpfEl   = document.querySelector('#cpf');
  const hintEl  = document.querySelector('#cpf-hint');

  // evite limpar o CPF quando atingir 11 dígitos
  let lastLoadedCpf = null;

  function setHint(msg) {
    if (!hintEl) return;
    hintEl.textContent = msg || '';
    hintEl.style.display = msg ? 'block' : 'none';
  }

  function fillForm(saved) {
    // preencha aqui os outros campos se existirem no seu form
    if (saved) {
      document.querySelector('#name').value = saved.name || '';
      document.querySelector('#birth').value = saved.birthDate || '';
      document.querySelector('#phone').value = saved.phone || '';
      document.querySelector('#email').value = saved.email || '';
      document.querySelector('#notes').value = saved.notes || '';
    }
  }

  cpfEl.addEventListener('input', () => {
    // mantém somente números e limita a 11
    let digits = cpfEl.value.replace(/\D/g, '');
    if (digits.length > 11) digits = digits.slice(0, 11);
    cpfEl.value = digits;

    if (digits.length < 11) {
      setHint('CPF deve conter 11 dígitos.');
      return;
    }

    // Para DEMO: aceita qualquer 11 dígitos (não limpa o campo!)
    setHint('');

    // Auto-load de dados locais se existir, SEM apagar o CPF quando não existir
    if (digits !== lastLoadedCpf) {
      lastLoadedCpf = digits;
      const saved = JSON.parse(localStorage.getItem(`patient:${digits}`) || 'null');
      if (saved) fillForm(saved);
    }
  });

  // Exemplo de persistência no submit (ajuste ao seu form)
  const form = document.querySelector('form') || document.getElementById('cadastro-form');
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const cpf = cpfEl.value.replace(/\D/g, '');
      if (cpf.length !== 11) { setHint('CPF deve conter 11 dígitos.'); return; }

      // colete os dados do formulário (ajuste os seletores)
      const payload = {
        id: cpf,                   // usamos CPF como patientId na demo
        name: document.querySelector('#name')?.value || '',
        birthDate: document.querySelector('#birth')?.value || '',
        phone: document.querySelector('#phone')?.value || '',
        email: document.querySelector('#email')?.value || '',
        notes: document.querySelector('#notes')?.value || ''
      };

      // salva localmente (demo)
      localStorage.setItem(`patient:${cpf}`, JSON.stringify(payload));

      // tenta enviar para o backend (ignora erro na demo)
      try {
        const INTERNAL_URL = window.__INTERNAL_URL__ || document.querySelector('#url-internal')?.textContent?.trim();
        if (INTERNAL_URL) {
          await fetch(`${INTERNAL_URL.replace(/\/$/, '')}/patients`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        }
      } catch(_) {}

      setHint('Cadastro salvo com sucesso!');
      // redireciona para Demo Médico com patientId preenchido
      location.href = `/demo.html?patientId=${cpf}`;
    });
  }
})();
</script>
</body>
</html>
