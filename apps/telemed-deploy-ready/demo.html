<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TeleMed — Demo para Médicos</title>
  <meta name="telemed-no-guard" content="1" />
  <style>
    :root{
      --brand:#0ea5e9; --ink:#0b1324; --ok:#059669; --bad:#dc2626;
      --text:#111827; --muted:#6b7280; --card:#fff; --border:#e5e7eb; --bg:#f8fafc;
    }
    *{box-sizing:border-box} body{margin:0;padding:24px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
    .hero{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    .hero h1{margin:0}
    .hero .tag{background:var(--brand);color:#fff;padding:6px 10px;border-radius:999px;font-size:.85rem}
    .links a{margin-right:8px;color:var(--brand);text-decoration:none;border-bottom:1px dashed var(--brand)}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .muted{color:var(--muted)}
    .btn{background:var(--brand);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    label{display:block;font-size:.9rem;margin:6px 0 4px}
    pre{background:#0b1020;color:#e5e7eb;padding:12px;border-radius:10px;overflow:auto;font-size:12px}
    .row{display:flex;gap:8px;align-items:center}.row>*{flex:1}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .presenter{position:fixed;right:16px;bottom:16px;z-index:50;background:var(--ink);color:#e5e7eb;border-radius:12px;padding:12px 14px;box-shadow:0 10px 25px rgba(0,0,0,.25);width:320px;max-height:60vh;overflow:auto;display:none}
    .presenter h3{margin:8px 0 6px;font-size:14px}.presenter p,.presenter li{font-size:12px;color:#cbd5e1}.presenter .close{position:absolute;top:6px;right:10px;cursor:pointer}
    .presenter-toggle{position:fixed;right:16px;bottom:16px;z-index:51}
    .card.success{background:#f0f9ff;border-color:#0ea5e9}
    .card.success h4{margin:0 0 10px;color:#0369a1}
    .card.success ol, .card.success ul{margin:0;padding-left:20px}
    .card.success a{color:#0ea5e9;text-decoration:none}
    .card.success a:hover{text-decoration:underline}
    .card.success code{background:#e0f2fe;color:#0369a1;padding:2px 4px;border-radius:4px}
  </style>
</head>
<body>
  <header class="hero">
    <span class="tag">TeleMed</span>
    <h1>Demo para Médicos</h1>
    <div class="links">
      <a href="/index.html">Home</a>
      <a href="/example-integration.html">Exemplo simples</a>
    </div>
    <button class="btn presenter-toggle" onclick="togglePresenter()">Roteiro</button>
  </header>

  <section class="card">
    <h2>0) Pre-Flight / Healthchecks</h2>
    <p class="muted">Configure os endpoints e verifique <code>/healthz</code>.</p>
    <div class="grid">
      <div>
        <label>AUCTION_URL</label>
        <input id="auUrl" placeholder="https://telemed-auction.onrender.com" />
        <button class="btn" id="checkAuction">Testar Auction</button>
        <div id="outAuction"></div>
      </div>
      <div>
        <label>INTERNAL_URL</label>
        <input id="inUrl" placeholder="https://telemed-internal.onrender.com" />
        <button class="btn" id="checkInternal">Testar Internal</button>
        <div id="outInternal"></div>
      </div>
      <div>
        <label>PRODUCTIVITY_URL</label>
        <input id="prodUrl" placeholder="https://telemed-productivity.onrender.com" />
        <button class="btn" id="checkProd">Testar Productivity</button>
        <div id="outProd"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>1) Leilão Reverso — Criar BID</h2>
    <div class="grid">
      <div>
        <label>patientId</label>
        <input id="patientId" value="paciente-demo" />
        <label for="specialty">Especialidade desejada</label>
        <select id="specialty" name="specialty">
          <option value="">Selecione…</option>
          <option>Clínica Geral</option>
          <option>Cardiologia</option>
          <option>Dermatologia</option>
          <option>Endocrinologia</option>
          <option>Gastroenterologia</option>
          <option>Geriatria</option>
          <option>Ginecologia</option>
          <option>Infectologia</option>
          <option>Neurologia</option>
          <option>Oftalmologia</option>
          <option>Ortopedia</option>
          <option>Otorrinolaringologia</option>
          <option>Pediatria</option>
          <option>Psiquiatria</option>
          <option>Reumatologia</option>
          <option>Urologia</option>
        </select>
        <label>isImmediate</label>
        <select id="isImmediate">
          <option value="true" selected>true</option>
          <option value="false">false</option>
        </select>
        <label>amountCents</label>
        <input id="amountCents" type="number" value="9000" />
        <button class="btn" id="btnCreateBid">Criar BID (seed)</button>
        <div id="outCreateBid" class="muted"></div>
      </div>
      <div>
        <label>Bid ID (preenchido após criar)</label>
        <input id="bidId" />
        <label>Modo</label>
        <select id="mode">
          <option value="immediate" selected>immediate</option>
          <option value="scheduled">scheduled</option>
        </select>
        <label>scheduledFor (ISO)</label>
        <input id="scheduledFor" placeholder="2025-09-04T14:00:00Z" />
        <button class="btn" id="btnAcceptBid">Aceitar BID → criar consulta</button>
        <div id="outAcceptBid" class="muted"></div>
      </div>
    </div>
  </section>

  <!-- Próximos passos -->
  <div id="next-steps" class="card" style="margin-top:16px;padding:16px;border:1px solid #0ea5e9;background:#eef7ff">
    <h4 style="margin:0 0 8px">Próximos passos</h4>
    <ol style="margin:0;padding-left:18px">
      <li>Aguarde criar/aceitar o BID…</li>
      <li>Opcional: <a target="_blank" href="/example-integration.html#scribe">Abrir Scribe/CIDs</a></li>
      <li><a href="/index.html">Voltar ao Hub</a></li>
    </ol>
  </div>

  <section class="card">
    <h2>2) Atalhos</h2>
    <div class="grid">
      <a class="btn" target="_blank" id="openAuction">Abrir Auction</a>
      <a class="btn" target="_blank" id="openProd">Abrir Productivity</a>
    </div>
  </section>

  <section class="card">
    <h2>Logs</h2>
    <pre id="log"></pre>
  </section>

  <div class="presenter" id="presenter">
    <span class="close" onclick="togglePresenter()">✖</span>
    <h3>Roteiro Rápido (15–20 min)</h3>
    <ol>
      <li>Health: Auction + Internal + Productivity → OK</li>
      <li>Criar BID (seed) → copiar <em>Bid ID</em></li>
      <li>Aceitar BID (immediate) → mostrar <code>appointment</code></li>
      <li>Explicar prontuário/IA (Productivity) na demo verbal (link "Abrir Productivity").</li>
    </ol>
    <h3>Mensagens-chave</h3>
    <ul>
      <li>Suporte à decisão; médico no comando.</li>
      <li>Padronização e agilidade.</li>
      <li>Integração ponta-a-ponta (lance → consulta).</li>
    </ul>
  </div>

  <script>
    function togglePresenter(){
      const x=document.getElementById('presenter');
      x.style.display = (x.style.display==='none'||!x.style.display)?'block':'none';
    }

    const logEl = document.getElementById('log');
    function log(msg, obj){
      const line = '['+new Date().toISOString()+'] '+msg+'\n';
      logEl.textContent += line + (obj? JSON.stringify(obj,null,2)+'\n' : '');
      logEl.scrollTop = logEl.scrollHeight;
    }

    const AU = document.getElementById('auUrl');
    const IN = document.getElementById('inUrl');
    const PR = document.getElementById('prodUrl');

    // Sugestão: preencher automaticamente se já sabe as URLs
    AU.value = 'https://telemed-auction.onrender.com';
    IN.value = 'https://telemed-internal.onrender.com';
    PR.value = 'https://telemed-productivity.onrender.com';
    document.getElementById('openAuction').href = AU.value;
    document.getElementById('openProd').href    = PR.value;

    async function health(url, outId){
      const out = document.getElementById(outId);
      out.innerHTML = '';
      if(!url){ out.innerHTML='<span class="bad">URL vazia</span>';return; }
      try{
        const r = await fetch(url.replace(/\/$/,'') + '/healthz');
        const j = await r.json();
        out.innerHTML = (r.ok && j.ok) ? '<span class="ok">OK</span>' : '<span class="bad">'+r.status+'</span>';
        log('health '+url, j);
      }catch(e){
        out.innerHTML = '<span class="bad">erro</span>';
        log('health '+url+' erro', {error:String(e)});
      }
    }
    document.getElementById('checkAuction').onclick = ()=>health(AU.value,'outAuction');
    document.getElementById('checkInternal').onclick= ()=>health(IN.value,'outInternal');
    document.getElementById('checkProd').onclick    = ()=>health(PR.value,'outProd');

    // --- MOSTRAR OS LINKS AUTOMATICAMENTE ---
    const $next = document.getElementById('next-steps');

    function showNextSteps({ bidId, appointmentId }) {
      const room    = appointmentId || 'telemed-demo';
      const waitUrl = `/sala-de-espera.html?appointmentId=${encodeURIComponent(room)}`;
      const jitsiUrl= `/video.html?room=${encodeURIComponent(room)}`;

      $next.innerHTML = `
        <h4 style="margin:0 0 8px">Próximos passos</h4>
        <ol style="margin:0;padding-left:18px">
          ${bidId ? `<li>Bid criado: <code>${bidId}</code>.</li>` : ''}
          ${appointmentId ? `
            <li>Consulta criada: <code>${appointmentId}</code></li>
            <li>Paciente: abrir a <a target="_blank" href="${waitUrl}">Sala de Espera</a>.</li>
            <li>Médico: entrar na <a target="_blank" href="${jitsiUrl}">Sala de Vídeo</a>.</li>
          ` : `
            <li>Com o Bid ID, aceite o lance (lado direito) para criar a consulta.</li>
          `}
          <li>Opcional: <a target="_blank" href="/example-integration.html#scribe">Abrir Scribe/CIDs</a></li>
          <li><a href="/index.html">Voltar ao Hub</a></li>
        </ol>`;
    }

    // --- INTEGRAÇÃO SIMPLES (cola sem pensar) ---
    // chame quando o BID for criado:
    window.onBidCreated = (res) => {
      // res precisa ter { bidId }
      showNextSteps({ bidId: res?.bidId });
    };

    // chame quando o BID for ACEITO (consulta criada):
    window.onBidAccepted = (res) => {
      // res precisa ter { bidId, appointmentId }
      showNextSteps({ bidId: res?.bidId, appointmentId: res?.appointmentId });
    };

    // opcional: se já existir um Bid ID na página, mostrar logo de cara
    // (troque "CURRENT_BID_ID" se você tiver essa info disponível)
    // showNextSteps({ bidId: CURRENT_BID_ID });

    document.getElementById('btnCreateBid').onclick = async ()=>{
      const auctionUrl = document.querySelector('#auUrl').value.trim();
      const patientId = document.querySelector('#patientId').value.trim();
      const amountCents = Number(document.querySelector('#amountCents').value || 0);
      const mode = document.querySelector('#mode').value;   // "immediate" | "scheduled"
      const specialty = document.querySelector('#specialty')?.value || '';
      const scheduledFor = document.querySelector('#scheduledFor').value; // ISO

      const body = { patientId, amountCents, mode, specialty };
      if (mode === 'scheduled' && scheduledFor) body.scheduledFor = new Date(scheduledFor).toISOString();

      const out = document.getElementById('outCreateBid'); out.textContent='Enviando…';
      try{
        const res = await fetch(`${auctionUrl}/bids`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await res.json();   // se res.ok, data.bid.id terá o ID
        if(res.ok && data?.bid?.id){
          document.getElementById('bidId').value = data.bid.id;
          out.innerHTML = '<span class="ok">Criado</span>';
          if(window.onBidCreated) window.onBidCreated({bidId: data.bid.id});  // Chama função dos próximos passos
        }else{
          out.innerHTML = '<span class="bad">Falha</span>';
        }
        log('create-bid', data);
      }catch(e){
        out.innerHTML = '<span class="bad">Erro</span>'; log('create-bid erro', {error:String(e)});
      }
    };

    document.getElementById('btnAcceptBid').onclick = async ()=>{
      const auctionUrl = document.querySelector('#auUrl').value.trim();
      const bidId = document.getElementById('bidId').value;
      const mode = document.getElementById('mode').value;
      const patientId = document.getElementById('patientId').value.trim();
      const out = document.getElementById('outAcceptBid');
      if(!bidId){ out.innerHTML='<span class="bad">Informe o Bid ID</span>'; return; }
      
      out.textContent='Enviando…';
      try{
        const r = await fetch(`${auctionUrl}/bids/${bidId}/accept`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode,                  // "immediate" ou "scheduled"
            patientId              // obrigatório
          })
        });
        
        const j = await r.json();
        if(r.ok && j?.ok) {
          out.innerHTML = '<span class="ok">Consulta criada</span>';
          if(window.onBidAccepted) window.onBidAccepted({bidId: bidId, appointmentId: j?.appointment?.id});  // Chama função dos próximos passos
        } else {
          out.innerHTML = '<span class="bad">'+(j?.error||'Falha')+'</span>';
        }
        log('accept-bid', j);
      }catch(e){
        out.innerHTML = '<span class="bad">Erro</span>'; log('accept-bid erro', {error:String(e)});
      }
    };
  </script>

<script>
  (function () {
    const params = new URLSearchParams(location.search);
    const pid = params.get('patientId') || params.get('cpf'); // fallback, caso venha como cpf
    if (!pid) return;

    // tente achar o input de patientId nos dois layouts mais comuns
    const candidates = [
      document.querySelector('input[name="patientId"]'),
      document.querySelector('#patientId'),
    ].filter(Boolean);

    if (candidates.length) {
      candidates[0].value = pid;
      // opcional: rolar até a seção do leilão
      const section = document.querySelector('h1, h2, h3');
      if (section) section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  })();
</script>
</body>
</html>